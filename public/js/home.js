// Generated by CoffeeScript 1.6.3
(function() {
  $(function() {
    var getStatusCss, getStatusId;
    $('#clothes-id').focus();
    $('#btn-clear').click(function(e) {
      e.preventDefault();
      $('#clothes-table table tbody tr').remove();
      $('#action-buttons').hide();
      return $('#clothes-id').focus();
    });
    $('#btn-clothes-search').click(function(e) {
      return $('#clothes-search-form').trigger('submit');
    });
    getStatusCss = function(status) {
      var css;
      switch (status) {
        case '대여가능':
          css = 'label-success';
          break;
        case '대여중':
          css = 'label-important';
          break;
        case '대여불가':
          css = 'label-inverse';
          break;
        case '예약':
          css = 'label-inverse';
          break;
        case '세탁':
          css = 'label-inverse';
          break;
        case '수선':
          css = 'label-inverse';
          break;
        case '분실':
          css = 'label-inverse';
          break;
        case '폐기':
          css = 'label-inverse';
          break;
        case '반납':
          css = 'label-inverse';
          break;
        case '부분반납':
          css = 'label-warning';
          break;
        case '반납배송중':
          css = 'label-warning';
          break;
        default:
          css = '';
      }
      return css;
    };
    getStatusId = function(status) {
      var id;
      switch (status) {
        case '대여가능':
          id = 1;
          break;
        case '대여중':
          id = 2;
          break;
        case '대여불가':
          id = 3;
          break;
        case '예약':
          id = 4;
          break;
        case '세탁':
          id = 5;
          break;
        case '수선':
          id = 6;
          break;
        case '분실':
          id = 7;
          break;
        case '폐기':
          id = 8;
          break;
        case '반납':
          id = 9;
          break;
        case '부분반납':
          id = 10;
          break;
        case '반납배송중':
          id = 11;
          break;
        default:
          id = undef;
      }
      return id;
    };
    $('#clothes-search-form').submit(function(e) {
      var clothes_id;
      e.preventDefault();
      clothes_id = $('#clothes-id').val();
      $('#clothes-id').val('').focus();
      if (!clothes_id) {
        return;
      }
      return $.ajax("/api/clothes/" + clothes_id + ".json", {
        type: 'GET',
        dataType: 'json',
        success: function(data, textStatus, jqXHR) {
          var $html, compiled, html;
          data.code = data.code.replace(/^0/, '');
          if (data.status === '대여중') {
            if ($("#clothes-table table tbody tr[data-order-id='" + data.order.id + "']").length) {
              return;
            }
            compiled = _.template($('#tpl-row-checkbox-clothes-with-order').html());
            $html = $(compiled(data));
            if (data.order.overdue) {
              compiled = _.template($('#tpl-overdue-paragraph').html());
              html = compiled(data);
              $html.find("td:last-child").append(html);
            }
          } else {
            if ($("#clothes-table table tbody tr[data-clothes-code='" + data.code + "']").length) {
              return;
            }
            compiled = _.template($('#tpl-row-checkbox-clothes').html());
            $html = $(compiled(data));
            if (data.status === '대여가능') {
              $('#action-buttons').show();
            }
          }
          $html.find('.order-status').addClass(getStatusCss(data.status));
          return $("#clothes-table table tbody").append($html);
        },
        error: function(jqXHR, textStatus, errorThrown) {
          return alert('error', jqXHR.responseJSON.error);
        },
        complete: function(jqXHR, textStatus) {}
      });
    });
    $('#action-buttons li > a').click(function(e) {
      var clothes, status_id;
      clothes = [];
      $('#clothes-table input:checked').each(function(i, el) {
        if ($(el).attr('id') === 'input-check-all') {
          return;
        }
        return clothes.push($(el).data('clothes-code'));
      });
      clothes = _.uniq(clothes);
      if (!clothes.length) {
        return;
      }
      status_id = getStatusId(this.innerHTML.replace(/^\s+|\s+$/g, ""));
      $.ajax("/api/clothes-list.json", {
        type: 'PUT',
        data: $.param({
          code: clothes,
          status_id: status_id
        }, true),
        dataType: 'json',
        success: function(data, textStatus, jqXHR) {
          return $.ajax("/api/clothes-list.json", {
            type: 'GET',
            data: $.param({
              code: clothes
            }, true),
            dataType: 'json',
            success: function(data, textStatus, jqXHR) {
              var code, _i, _len, _results;
              _results = [];
              for (_i = 0, _len = data.length; _i < _len; _i++) {
                clothes = data[_i];
                code = clothes.code.replace(/^0/, '');
                _results.push($("#clothes-table table tbody tr[data-clothes-code='" + code + "'] td:nth-child(3) span.order-status").html(clothes.status).removeClass(function(i, c) {
                  return c;
                }).addClass(['order-status', 'label', getStatusCss(clothes.status)].join(' ')));
              }
              return _results;
            },
            error: function(jqXHR, textStatus, errorThrown) {
              return alert('error', jqXHR.responseJSON.error);
            }
          });
        },
        error: function(jqXHR, textStatus, errorThrown) {
          return alert('error', jqXHR.responseJSON.error);
        }
      });
      return $('#clothes-id').focus();
    });
    return $('#input-check-all').click(function(e) {
      var is_checked;
      is_checked = $('#input-check-all').is(':checked');
      return $(this).closest('thead').next().find('.ace:checkbox:not(:disabled)').prop('checked', is_checked);
    });
  });

}).call(this);
