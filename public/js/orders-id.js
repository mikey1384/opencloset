// Generated by CoffeeScript 1.6.3
(function() {
  $(function() {
    var additional_fee, clothes, commify, discount_fee, origin_fee, overdue_calc, refresh_total_fee, total_fee;
    $('.clickable.label').click(function() {
      return $(this).parent().prev().val($(this).text());
    });
    origin_fee = parseInt($('#input-price').val() || 0);
    additional_fee = 0;
    discount_fee = parseInt($('input[name=discount]').val() || 0);
    total_fee = origin_fee + additional_fee - discount_fee;
    commify = function(fee) {
      var regex;
      fee += '';
      regex = /(^[+-]?\d+)(\d{3})/;
      while (regex.test(fee)) {
        fee = fee.replace(regex, '$1' + ',' + '$2');
      }
      return fee;
    };
    refresh_total_fee = function() {
      discount_fee = parseInt($('input[name=discount]').val() || 0);
      total_fee = origin_fee + additional_fee - discount_fee;
      $('#total_fee').text(commify(total_fee));
      $('#origin_fee').text(commify(origin_fee));
      $('#additional_fee').text(commify(additional_fee));
      return $('#discount_fee').text(commify(discount_fee));
    };
    refresh_total_fee();
    $('input[name=discount],input[name=price]').ForceNumericOnly();
    $('#input-target-date').datepicker({
      format: 'yyyy-mm-dd',
      autoclose: true,
      startDate: new Date(),
      language: 'kr'
    }).on('changeDate', function(e) {
      var additional_days;
      additional_days = overdue_calc(new Date(), $('#input-target-date').datepicker('getDate'));
      additional_fee = parseInt(additional_days * origin_fee * 0.2);
      $('#input-price').val(origin_fee + additional_fee);
      return refresh_total_fee();
    });
    $('input[name=discount]').keyup(function(e) {
      return refresh_total_fee();
    });
    overdue_calc = function(target_dt, return_dt) {
      var DAY_AS_SECONDS, dur;
      DAY_AS_SECONDS = 60 * 60 * 24;
      dur = return_dt.getTime() - (DAY_AS_SECONDS * 1000 * 2) - target_dt.getTime();
      if (dur < 0) {
        return 0;
      }
      return parseInt(dur / 1000 / DAY_AS_SECONDS);
    };
    $('#btn-order-cancel:not(.disabled)').click(function(e) {
      var $this;
      e.preventDefault();
      $this = $(this);
      $this.addClass('disabled');
      return $.ajax("" + ($this.attr('href')) + ".json", {
        type: 'DELETE',
        dataType: 'json',
        success: function(data, textStatus, jqXHR) {
          _alert('주문이 취소 되었습니다');
          return location.href = '/';
        },
        error: function(jqXHR, textStatus, errorThrown) {
          return alert('error', jqXHR.responseJSON.error);
        },
        complete: function(jqXHR, textStatus) {
          return $this.removeClass('disabled');
        }
      });
    });
    clothes = [];
    $('.input-cloth').each(function(i, el) {
      return clothes.push($(el).data('cloth-code'));
    });
    $('#input-cloth-code').focus();
    $('#btn-cloth-code').click(function(e) {
      return $('#form-cloth-code').trigger('submit');
    });
    $('#form-cloth-code').submit(function(e) {
      var cloth_code, found;
      e.preventDefault();
      cloth_code = $('#input-cloth-code').val();
      $('#input-cloth-code').val('').focus();
      found = _.find(clothes, function(val) {
        return val === cloth_code;
      });
      if (!found) {
        return alert("Not found " + cloth_code);
      }
      return $(".input-cloth[data-cloth-code=" + found + "]").attr('checked', true);
    });
    return $('#form-return').submit(function(e) {
      var action, clothes_code;
      clothes_code = [];
      $('.input-cloth:not(:checked)').each(function(i, el) {
        return clothes_code.push($(el).data('cloth-code'));
      });
      console.log($.putUrlVars({
        clothes: clothes_code.join()
      }));
      if ($('.input-cloth').length !== $('.input-cloth:checked').length) {
        if (confirm('반납품목이 제대로 체크 되지 않았습니다. 계속하시겠습니까?')) {
          action = $('#form-return').attr('action');
          $('#form-return').attr('action', "" + action + "?" + ($.putUrlVars({
            missing_clothes: clothes_code.join()
          })));
          return true;
        } else {
          return false;
        }
      }
      return true;
    });
  });

}).call(this);
