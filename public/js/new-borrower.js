// Generated by CoffeeScript 1.6.3
(function() {
  $(function() {
    var addRegisteredUser, userID, validation, why;
    userID = void 0;
    $('#input-phone').ForceNumericOnly();
    addRegisteredUser = function() {
      var query;
      query = $('#user-search').val();
      if (!query) {
        return;
      }
      return $.ajax("/api/search/user.json", {
        type: 'GET',
        data: {
          q: query
        },
        success: function(data, textStatus, jqXHR) {
          var compiled;
          compiled = _.template($('#tpl-user-id').html());
          _.each(data, function(user) {
            var $html;
            if (!$("#user-search-list input[data-user-id='" + user.id + "']").length) {
              $html = $(compiled(user));
              $html.find('input').attr('data-json', JSON.stringify(user));
              return $("#user-search-list").prepend($html);
            }
          });
          if (data[0]) {
            return $("input[name=user-id][value=" + data[0].id + "]").click();
          }
        },
        error: function(jqXHR, textStatus, errorThrown) {
          var type, _ref;
          type = (_ref = jqXHR.status === 404) != null ? _ref : {
            'warning': 'danger'
          };
          return alert(type, jqXHR.responseJSON.error.str);
        },
        complete: function(jqXHR, textStatus) {}
      });
    };
    $('#user-search-list').on('click', ':radio', function(e) {
      var g;
      userID = $(this).data('user-id');
      if ($(this).val() === '0') {
        return;
      }
      g = JSON.parse($(this).attr('data-json'));
      return _.each(['name', 'email', 'phone', 'address', 'gender', 'birth', 'height', 'weight', 'bust', 'waist', 'hip', 'belly', 'thigh', 'arm', 'leg', 'knee', 'foot'], function(name) {
        var $input;
        $input = $("input[name=" + name + "]");
        if ($input.attr('type') === 'radio' || $input.attr('type') === 'checkbox') {
          return $input.each(function(i, el) {
            if ($(el).val() === g[name]) {
              return $(el).attr('checked', true);
            }
          });
        } else {
          return $input.val(g[name]);
        }
      });
    });
    $('#user-search').keypress(function(e) {
      if (e.keyCode === 13) {
        return addRegisteredUser();
      }
    });
    $('#btn-user-search').click(function() {
      return addRegisteredUser();
    });
    addRegisteredUser();
    $('#input-target-date').datepicker({
      startDate: "-0d",
      language: 'kr',
      format: 'yyyy-mm-dd',
      autoclose: true
    });
    $('#btn-sendsms:not(.disabled)').click(function(e) {
      var $this, to;
      e.preventDefault();
      $this = $(this);
      $this.addClass('disabled');
      to = $('#input-phone').val();
      if (!to) {
        return;
      }
      return $.ajax("/sms.json", {
        type: 'POST',
        data: {
          to: to
        },
        success: function(data, textStatus, jqXHR) {
          return alert('success', "" + to + " 번호로 SMS 가 발송되었습니다");
        },
        error: function(jqXHR, textStatus, errorThrown) {
          return alert('danger', jqXHR.responseJSON.error);
        },
        complete: function(jqXHR, textStatus) {
          return $this.removeClass('disabled');
        }
      });
    });
    validation = false;
    $('#fuelux-wizard').ace_wizard().on('change', function(e, info) {
      var ajax;
      if (info.step === 1 && validation) {
        if (!$('#validation-form').valid()) {
          return false;
        }
      }
      if (info.direction !== 'next') {
        return true;
      }
      ajax = {};
      switch (info.step) {
        case 2:
          if (userID) {
            ajax.type = 'PUT';
            ajax.path = "/api/user/" + userID + ".json";
          } else {
            ajax.type = 'POST';
            ajax.path = '/api/user.json';
          }
          return $.ajax(ajax.path, {
            type: ajax.type,
            data: $('form').serialize(),
            success: function(data, textStatus, jqXHR) {
              userID = data.id;
              return true;
            },
            error: function(jqXHR, textStatus, errorThrown) {
              alert('danger', jqXHR.responseJSON.error);
              return false;
            },
            complete: function(jqXHR, textStatus) {}
          });
        case 3:
          if (userID) {
            ajax.type = 'PUT';
            ajax.path = "/api/user/" + userID + ".json";
          } else {
            ajax.type = 'POST';
            ajax.path = '/api/user.json';
          }
          return $.ajax(ajax.path, {
            type: ajax.type,
            data: $('form').serialize(),
            success: function(data, textStatus, jqXHR) {
              userID = data.id;
              return true;
            },
            error: function(jqXHR, textStatus, errorThrown) {
              alert('danger', jqXHR.responseJSON.error);
              return false;
            },
            complete: function(jqXHR, textStatus) {}
          });
      }
    }).on('finished', function(e) {
      var bust, waist;
      e.preventDefault();
      bust = $("input[name=bust]").val();
      waist = $("input[name=waist]").val();
      location.href = "/search?q=" + (parseInt(bust) + 3) + "/" + waist + "//1/&gid=" + userID;
      return false;
    }).on('stepclick', function(e) {});
    why = $('#user-why').tag({
      placeholder: $('#user-why').attr('placeholder'),
      source: ['입사면접', '사진촬영', '결혼식', '장례식', '입학식', '졸업식', '세미나', '발표']
    });
    return $('.user-why .clickable.label').click(function() {
      var e, text;
      text = $(this).text();
      e = $.Event('keydown', {
        keyCode: 13
      });
      return $('input#purpose').next().val(text).trigger(e);
    });
  });

}).call(this);
