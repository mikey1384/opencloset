// Generated by CoffeeScript 1.6.3
(function() {
  $(function() {
    $('#query').focus();
    $('#btn-clear').click(function(e) {
      e.preventDefault();
      $('#clothes-table table tbody tr').remove();
      $('#user-table table tbody tr').remove();
      $('#action-buttons').hide();
      return $('#query').focus();
    });
    $('#btn-search').click(function(e) {
      return $('#search-form').trigger('submit');
    });
    $('#search-form').submit(function(e) {
      var query;
      e.preventDefault();
      query = $('#query').val();
      $('#query').val('').focus();
      if (!query) {
        return;
      }
      if (query.length === 4) {
        $.ajax("/api/clothes/" + query + ".json", {
          type: 'GET',
          dataType: 'json',
          success: function(data, textStatus, jqXHR) {
            var $html, compiled, html;
            data.code = data.code.replace(/^0/, '');
            data.categoryStr = OpenCloset.category[data.category].str;
            if ($("#clothes-table table tbody tr[data-clothes-code='" + data.code + "']").length) {
              return;
            }
            if (data.status === '대여중') {
              compiled = _.template($('#tpl-row-checkbox-disabled-with-order').html());
              $html = $(compiled(data));
              if (data.order.overdue) {
                compiled = _.template($('#tpl-overdue-paragraph').html());
                html = compiled(data);
                $html.find("td:last-child").append(html);
              }
            } else if (data.status === '대여가능') {
              compiled = _.template($('#tpl-row-checkbox-enabled').html());
              $html = $(compiled(data));
              if (data.status === '대여가능') {
                $('#action-buttons').show();
              }
            } else {
              compiled = _.template($('#tpl-row-checkbox-disabled-without-order').html());
              $html = $(compiled(data));
            }
            $html.find('.order-status').addClass(OpenCloset.status[data.status].css);
            return $("#clothes-table table tbody").append($html);
          },
          error: function(jqXHR, textStatus, errorThrown) {
            if (jqXHR.status === 404) {
              return alert('warning', "" + query + " 의류는 찾을 수 없습니다.");
            }
          },
          complete: function(jqXHR, textStatus) {}
        });
      }
      return $.ajax('/api/search/user.json', {
        type: 'GET',
        data: {
          q: query
        },
        dataType: 'json',
        success: function(data, textStatus, jqXHR) {
          var $html, compiled, user, _i, _len, _results;
          _results = [];
          for (_i = 0, _len = data.length; _i < _len; _i++) {
            user = data[_i];
            if ($("#user-table table tbody tr[data-user-id='" + user.id + "']").length) {
              continue;
            }
            compiled = _.template($('#tpl-row-radio').html());
            $html = $(compiled(user));
            _results.push($("#user-table table tbody").append($html));
          }
          return _results;
        },
        error: function(jqXHR, textStatus, errorThrown) {
          if (jqXHR.status === 404) {
            return alert('warning', "" + query + " 검색어와 관련있는 사용자는 찾을 수 없습니다.");
          }
        },
        complete: function(jqXHR, textStatus) {}
      });
    });
    $('#input-check-all').click(function(e) {
      var is_checked;
      is_checked = $('#input-check-all').is(':checked');
      return $(this).closest('thead').next().find('.ace:checkbox:not(:disabled)').prop('checked', is_checked);
    });
    return $('#action-buttons').click(function(e) {
      var clothes, user;
      user = $('input[name=user_id]:checked').val();
      clothes = [];
      $('input[name=clothes_code]:checked').each(function(i, el) {
        if ($(el).attr('id') === 'input-check-all') {
          return;
        }
        return clothes.push($(el).data('clothes-code'));
      });
      clothes = _.uniq(clothes);
      if (!user) {
        return alert('danger', '대여할 사용자를 선택해 주세요');
      }
      if (!clothes) {
        return alert('danger', '대여할 옷을 선택해 주세요.');
      }
      return $('#order-form').submit();
    });
  });

}).call(this);
